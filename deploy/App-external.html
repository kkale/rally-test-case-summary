<!DOCTYPE html>
<html>
<head>
    <title>test-case-status</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("test-case-status",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.iterationCombobox=this.add({xtype:"rallyiterationcombobox",listeners:{ready:this._onIterationComboboxLoad,select:this._onIterationComboboxLoad,scope:this}}),Ext.define("TableDataObject",{extend:"Ext.data.Model",fields:[{name:"userStoryName",type:"string"},{name:"numberOfTestsPlanned",type:"int"},{name:"numberOfTestsRan",type:"int"},{name:"percentComplete",type:"string"},{name:"testExecutionStatus",type:"string"}]}),this._statusDataStore=this._createTableStore("testCaseStatusStore"),this._statusTotalsDataStore=this._createTableStore("testCaseStatusTotalsStore"),this.statusGridPanel=this._createGridPanel("Test Case Status",this._statusDataStore),this.statusTotalsGridPanel=this._createGridPanel("Iteration Totals",this._statusTotalsDataStore)},_createTableStore:function(storeName){return Ext.create("Ext.data.Store",{storeId:storeName,model:"TableDataObject",data:{items:[]},proxy:{type:"memory",reader:{type:"json",root:"items"}}})},_createGridPanel:function(title,dataStore){return this.add(Ext.create("Ext.grid.Panel",{title:title,store:dataStore,columns:[{text:"Functional Area",dataIndex:"userStoryName"},{text:"Planned",dataIndex:"numberOfTestsPlanned"},{text:"Actual",dataIndex:"numberOfTestsRan"},{text:"% Complete",dataIndex:"percentComplete"},{text:"Status",dataIndex:"testExecutionStatus",tdCls:"testStatus",flex:1}],viewConfig:{getRowClass:function(record,index,rowParams,store){switch(status=record.get("testExecutionStatus")){case"In Progress":return"in_progress";case"Not Started":return"not_started";case"Complete":return"complete";default:return""}}}}))},_onIterationComboboxLoad:function(){this._loadTableData([this.iterationCombobox.getQueryFromSelected()])},_loadTableData:function(filters){this._statusDataStore.removeAll();var that=this;Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["Name","TestCaseCount","TestCases"],autoLoad:!0,filters:filters,listeners:{load:function(store,userStories){for(var x in userStories){var userStory=userStories[x];that._loadTestCases(userStory)}}}})},_refreshStatusTotalsTable:function(){this._statusTotalsDataStore.removeAll();var totalNumberOfTestsPlanned=0,totalNumberOfTestsRan=0;for(var x in this._statusDataStore.data.items){var row=this._statusDataStore.data.items[x].data;totalNumberOfTestsPlanned+=row.numberOfTestsPlanned,totalNumberOfTestsRan+=row.numberOfTestsRan}this._statusTotalsDataStore.add(Ext.create("TableDataObject",{userStoryName:"-",numberOfTestsPlanned:totalNumberOfTestsPlanned,numberOfTestsRan:totalNumberOfTestsRan,percentComplete:this._getPercentComplete(totalNumberOfTestsPlanned,totalNumberOfTestsRan),testExecutionStatus:this._getTestExecutionStatus(totalNumberOfTestsPlanned,totalNumberOfTestsRan)}))},_loadTestCases:function(userStory){var that=this;userStory.getCollection("TestCases").load({fetch:["LastRun"],callback:function(testCases,operation,success){var tableRowItem=that._getTableRowItem(userStory,testCases);that._statusDataStore.add(tableRowItem),that._refreshStatusTotalsTable()}})},_getTableRowItem:function(userStory,testCases){var userStoryName=userStory.get("Name"),numberOfTestsPlanned=parseInt(userStory.get("TestCaseCount"),10),numberOfTestsRan=this._getNumberOfTestsRan(testCases),percentComplete=this._getPercentComplete(numberOfTestsPlanned,numberOfTestsRan),testExecutionStatus=this._getTestExecutionStatus(numberOfTestsPlanned,numberOfTestsRan);return Ext.create("TableDataObject",{userStoryName:userStoryName,numberOfTestsPlanned:numberOfTestsPlanned,numberOfTestsRan:numberOfTestsRan,percentComplete:percentComplete,testExecutionStatus:testExecutionStatus})},_getNumberOfTestsRan:function(testCases){var testsRan=0;return Ext.Array.each(testCases,function(testCase){testCase.get("LastRun")&&testsRan++}),testsRan},_getTestExecutionStatus:function(numberOfTestsPlanned,numberOfTestsRan){var status="Not Started";return numberOfTestsPlanned===numberOfTestsRan&&0!==numberOfTestsPlanned?status="Complete":numberOfTestsRan>0&&(status="In Progress"),status},_getPercentComplete:function(numberOfTestsPlanned,numberOfTestsRan){var percentComplete=0;return 0!==numberOfTestsRan&&(percentComplete=parseInt(100*(numberOfTestsRan/numberOfTestsPlanned),10)),percentComplete+"%"}});

            Rally.launchApp('test-case-status', {
                name:"test-case-status",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        tr.x-grid-row.not_started>td{background-color:#FFD4D4}tr.x-grid-row.complete>td{background-color:#D0FFD0}tr.x-grid-row.in_progress>td{background-color:#FFFFBD}
    </style>
</head>
<body>
</body>
</html>
